<html>
<head>
    <script type="text/javascript"  src="/node_modules/gojs/release/go.js" charset="UTF-8"></script>
    <script type="text/javascript"  src="/node_modules/gojs/extensions/Figures.js" charset="UTF-8"></script>

    <script type="text/javascript"  src="resources-client.js" charset="UTF-8"></script>

    <script src="/node_modules/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <script type="text/javascript"  src="resources-client.js" charset="UTF-8"></script>
    <link rel="stylesheet" href="/node_modules/ag-grid-community/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="/node_modules/ag-grid-community/dist/styles/ag-theme-balham.css">

</head>

    <h1 id=selectedRows>Archi Views Telecom Model</h1>

    <div style="width: 100%; display: table;">
        <div style="display: table-row">
            <div id="myGrid" style="height: 120px; width:900px; display: table-cell;" class="ag-theme-balham"></div>
            <div style="height: 120px; width:300px; display: table-cell;">
                <button id="loadbutton" onclick="LoadDiagram()" disabled>Load Diagram</button>
            </div>
        </div>
    </div>

    <div id="myDiagramDiv" style="width:1900px; height:700px; background-color: #DAE4E4;"></div>

    <script >

        var $ = go.GraphObject.make;
        var myDiagram = $(go.Diagram, "myDiagramDiv",{ "undoManager.isEnabled": true });

/*
    GridLayout
    TreeLayout
    ForceDirectedLayout
    LayeredDigraphLayout
    CircularLayout
*/

        //myDiagram.layout = new go.LayeredDigraphLayout();

        myDiagram.nodeTemplate = $(
            go.Node, 
            { fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides }, 
            
            new go.Binding("location", "loc", go.Point.parse),
            

            { click: function(e, node) {
                var diagram = node.diagram;
                diagram.startTransaction("highlight");
                diagram.clearHighlighteds();
                node.findLinksOutOf().each(function(l) { l.isHighlighted = true; });
                node.findLinksInto().each(function(l) { l.isHighlighted = true; });
                node.findNodesOutOf().each(function(n) { n.isHighlighted = true; });
                node.findNodesInto().each(function(n) { n.isHighlighted = true; });
                node.isHighlighted = true;
                diagram.commitTransaction("highlight");}
            },

            $(go.Shape, new go.Binding("figure", selectfig ),

                new go.Binding("fill", selectstroke ),

                // the Shape.stroke color depends on whether Node.isHighlighted is true
                //new go.Binding("stroke", "isHighlighted", function(h) { return h ? "red" : "black"; }).ofObject(),
                new go.Binding("strokeWidth", "isHighlighted", function(h) { return h ? 3 : 1; }).ofObject(),
                new go.Binding("opacity", "isHighlighted", function(h) { return h ? 1 : 0.5; }).ofObject(),

               // { parameter1: 14, fill: "rgba(128,128,128,0.33)" },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify) ),
            $(go.TextBlock, new go.Binding("text", "name"), { width: 100, wrap: go.TextBlock.WrapDesiredSize,
             textAlign: "center", verticalAlignment: go.Spot.Center, margin: 1 ,isMultiline: true} ),

            { toolTip: $("ToolTip", $(go.TextBlock, { margin: 4 }, new go.Binding("text", "element_class")))}

            );

            myDiagram.linkTemplate = $(go.Link,

                                        { routing: go.Link.AvoidsNodes, corner: 10, curve: go.Link.JumpOver },
                                        $(go.Shape, 
                                          //  new go.Binding("stroke", "isHighlighted", function(h) { return h ? "red" : "black"; }).ofObject(),
                                            new go.Binding("strokeWidth", "isHighlighted", function(h) { return h ? 3 : 1; }).ofObject(),
                                            new go.Binding("opacity", "isHighlighted", function(h) { return h ? 0.5 : 0.3; }).ofObject()
                                         ),
                                        $(go.Shape, { toArrow: "Standard" },
                                            new go.Binding("strokeWidth", "isHighlighted", function(h) { return h ? 3 : 1; }).ofObject(),
                                            new go.Binding("opacity", "isHighlighted", function(h) { return h ? 0.5 : 0.3; }).ofObject()
                                        ),
                                        $(go.TextBlock, new go.Binding("text", "rel_name"), {font: "10pt Courier New"},
                                        //{  segmentOrientation: go.Link.OrientAlong, width: 200, wrap: go.TextBlock.WrapDesiredSize, textAlign: "center", verticalAlignment: go.Spot.Center, margin: 1 ,isMultiline: true},
                                            //new go.Binding("stroke", "isHighlighted", function(h) { return h ? "red" : "black"; }).ofObject(),
                                            //new go.Binding("font", "isHighlighted", function(h) { return h ? "11pt Courier New" : "9pt Courier New"; }).ofObject(),
                                            new go.Binding("strokeWidth", "isHighlighted", function(h) { return h ? 3 : 1; }).ofObject(),
                                            new go.Binding("opacity", "isHighlighted", function(h) { return h ? 1 : 0.2; }).ofObject()
                                        )
                                    );


             myDiagram.groupTemplate =   $(go.Group, "Vertical", 
                                        { selectionObjectName: "PH", locationObjectName: "PH", resizable: true, resizeObjectName: "PH" },
                                        $(go.TextBlock, { font: "Bold 10pt Sans-Serif", width: 300, wrap: go.TextBlock.WrapFit }, new go.Binding("text", "name")),
                                        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                                        $(go.Shape, { name: "PH" }, 
                                            new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
                                            new go.Binding("figure", selectfig ),
                                            new go.Binding("fill", selectstroke ),
                                            { toolTip: $("ToolTip", $(go.TextBlock, { margin: 4 }, new go.Binding("text", "element_class")))}
                                        )
                                    );


             myDiagram.click = function(e) {e.diagram.commit(function(d) { d.clearHighlighteds(); }, "no highlighteds");};

  

                

/*
         myDiagram.groupTemplate =  $(go.Group, "Auto", 

                                    $(go.Shape, "Rectangle", { fill: "orange", stroke: "darkorange" }),
                                        $(go.Panel, "Table", { margin: 0.5 }, 

                                            $(go.RowColumnDefinition, { row: 0, background: "white" }),
                                                $("SubGraphExpanderButton", { row: 0, column: 0, margin: 3 }),
                                                $(go.TextBlock, { row: 0, column: 1, font: "bold 14px Sans-Serif", stroke: "darkorange", textAlign: "center", stretch: go.GraphObject.Horizontal },
                                                    new go.Binding("text", "name")),
                                                $(go.Placeholder, { row: 1, columnSpan: 2, padding: 10, alignment: go.Spot.TopLeft },
                                                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                                                    new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),

                                                    new go.Binding("padding", "isSubGraphExpanded", function(exp) { return exp ? 10 : 0; } ).ofObject())
                                        )
                                    );
  */


        //myDiagram.model = new go.GraphLinksModel(getSQL("/getobj"), getSQL("/getrel"));

        function selectstroke(node) {

            var rta;
            switch(node.element_class) {
                case "ApplicationComponent":
                case "ApplicationInterface":
                case "ApplicationService":
                case "ImplementationEvent":
                case "Junction":
                    rta = "rgba(65, 218, 197 ,0.80)"; break;    // celeste

                case "WorkPackage":
                    rta = "rgba(240, 95, 128 ,0.80)"; break;    // rosa

                case null:
                    rta = "rgba(255, 255, 255, 0.5)"; break;    // blanco

                case "BusinessActor":
                case "BusinessInterface":
                case "BusinessProcess":
                case "BusinessObject":
                case "BusinessEvent":
                case "BusinessInteraction":
                    rta =  "rgba(255, 255, 100, 0.8)"; break;   // amarillo

                default:
                    rta = "rgba(128, 218, 65,0.50)"; break;     // verde
            }

            return rta;
            
        }


        function selectfig(node) { 

            var rta;
            switch(node.element_class) {
//                case "ApplicationComponent":
//                    rta = "Component"; break;
                case "ApplicationService":
                    rta = "PrimitiveToCall"; break;

                case "TechnologyService":
                    rta = "DividedEvent"; break;

                case "TechnologyFunction":
                    rta = "ExternalProcess"; break;

                case "ApplicationInterface":
                case "BusinessInterface":
                    rta = "TriangleRight"; break;

//              case "WorkPackage":
//                  rta = "RoundedRectangle"; break;

                case "ImplementationEvent":
                    rta = "DataStorage"; break;

                case "Junction":
                    rta = "Connector"; break;

                case null:
                    if (node.class == "DiagramModelNote") { rta = "Package"; break; }
//                    if (node.class == "DiagramModelGroup") { rta = "RoundedRectangle"; break; }

                case "ImplementationEvent":
                    rta = ""; break;

                case "BusinessActor":
                    rta = "BpmnTaskUser"; break;

                case "BusinessObject":
                    rta = "DividedProcess"; break;

                case "Node":
                    rta = "Cube2"; break;

                default:
                    rta = "RoundedRectangle"; break;
            }

            return rta;
        }


    </script>

    <script type="text/javascript" charset="utf-8">

        var selectedRowsString = '';

        const columnDefs = [
            {headerName: 'id', field: 'id', hide:true },
            {headerName: 'name', field: 'name' , resizable: true, sortable: true},
            {headerName: 'documentation', field: 'documentation', editable : true, resizable: true, sortable: true},
            {headerName: 'viewpoint', field: 'viewpoint', resizable: true, sortable: true},
        ];
        const rowData = getSQL("/get?id=2");

        const gridOptions = {
            columnDefs: columnDefs,
            rowData: rowData,
            rowSelection: 'single',
            onSelectionChanged: onSelectionChanged
        };
        const eGridDiv = document.querySelector('#myGrid');


        new agGrid.Grid(eGridDiv, gridOptions);

        function onSelectionChanged() {
        var selectedRows = gridOptions.api.getSelectedRows();

        selectedRows.forEach( function(selectedRow, index) {
           /* 
           if (index!==0) {
                selectedRowsString += ', ';
            }
            selectedRowsString += selectedRow.id;
            */
            selectedRowsString = selectedRow.id;

            document.querySelector('#selectedRows').innerHTML = selectedRow.name;
        });
        //console.log(selectedRowsString);
        document.getElementById("loadbutton").disabled = false;
       


        }

    </script>

    <script type="text/javascript" charset="utf-8">
        function LoadDiagram(){
            document.getElementById("loadbutton").disabled = true;
            myDiagram.model = new go.GraphLinksModel(getSQL("/get?id=0&view=" + selectedRowsString), getSQL("/get?id=1&view=" + selectedRowsString));
            document.getElementById("loadbutton").disabled = false;

            /*
            myDiagram.model.Fc.forEach(
                function(e){
                    console.log(e.loc + "\t" + e.name + "\t" + e.isGroup);}
            )
            */

        }
    </script>

</html>
